<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>マリオ風ゲーム - 10ステージ</title>
    <style>
        body { margin:0; padding:0; overflow:hidden; background:#5C94FC; font-family:Arial, sans-serif; }
        #gameContainer { position:relative; width:100vw; height:100vh; }
        canvas { position:absolute; inset:0; width:100%; height:100%; display:block; }
        .info { position:absolute; top:20px; left:20px; color:#fff; font-size:28px; font-weight:bold; text-shadow:3px 3px 0 #000; z-index:10; }
        .controls { position:absolute; bottom:20px; left:50%; transform:translateX(-50%); text-align:center; color:#fff; font-size:20px; text-shadow:2px 2px 0 #000; z-index:10; }
    </style>
</head>
<body>
<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div class="info">
        <div>ステージ: <span id="stage">1</span>/10</div>
        <div>スコア: <span id="score">0</span></div>
        <div>ライフ: <span id="lives">3</span></div>
    </div>
    <div class="controls">
        操作: 矢印キー(移動) / スペース(ジャンプ) / P(リスタート)
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// リサイズ
function resizeCanvas(){ canvas.width = innerWidth; canvas.height = innerHeight; }
resizeCanvas(); addEventListener('resize', resizeCanvas);

// 状態
let currentStage=1, score=0, lives=3, gameOver=false, levelComplete=false;
let cameraX=0, cameraY=0, stageWidth=1200, stageHeight=800;

// プレイヤー
const player = { x:100, y:300, width:40, height:50, velX:0, velY:0, speed:8, jumpPower:-20, grounded:false, color:'#FF0000' };

// 物理
const gravity=0.8, friction=0.8;

// 入力
const keys={};

// ステージ要素
let platforms=[], enemies=[], coins=[], spikes=[], movingPlatforms=[], goal={};

// ===== 安全ギャップ計算（最大飛距離の安全版） =====
function getSafeMaxGapPx(){
    // 飛行時間 t = 2*|vy0|/g, 水平距離 ≒ speed * t
    const t = 2 * Math.abs(player.jumpPower) / gravity;   // ≒50frame
    const maxDist = player.speed * t;                      // ≒400px
    return Math.floor(maxDist * 0.6);                      // 安全係数0.6 → ≒240px
}

// ===== 落とし穴の自動短縮：安全距離を超える地面ギャップを埋め戻す =====
function patchUnjumpableGaps(){
    const groundY = stageHeight - 100;
    const safeGap = getSafeMaxGapPx(); // ≒240
    // 同じ地面Yのgroundのみ抽出し、x昇順
    const grounds = platforms.filter(p=>p.type==='ground' && p.y===groundY).sort((a,b)=>a.x-b.x);
    for(let i=0;i<grounds.length-1;i++){
        const left = grounds[i], right = grounds[i+1];
        const gapStart = left.x + left.width;
        const gapEnd   = right.x;
        const gapW = gapEnd - gapStart;
        if(gapW > safeGap){
            const fillW = gapW - safeGap; // 残す隙間は安全距離
            if(fillW > 0){
                platforms.push({ x:gapStart, y:groundY, width:fillW, height:100, type:'ground' });
                // 新設地面と被るスパイクは除去（理不尽防止）
                spikes = spikes.filter(s => s.x + s.width <= gapStart || s.x >= gapStart + fillW);
            }
        }
    }
}

// ===== ゴール手前滑走路の保証（前回追加分） =====
function ensureGoalRunway(){
    const groundY = stageHeight - 100;
    const pad = 50, runwayBack = 400;
    const runwayStart = Math.max(0, goal.x - runwayBack);
    const runwayEnd   = Math.min(stageWidth, goal.x + goal.width + pad);
    const runwayWidth = Math.max(0, runwayEnd - runwayStart);
    spikes = spikes.filter(s => s.x + s.width <= runwayStart || s.x >= runwayEnd);
    platforms.push({ x:runwayStart, y:groundY, width:runwayWidth, height:100, type:'ground' });
    goal.y = groundY - goal.height;
}

// ステージ生成
function generateStage(stageNumber){
    platforms=[]; enemies=[]; coins=[]; spikes=[]; movingPlatforms=[];
    stageWidth = 1200 + (stageNumber-1)*800;
    stageHeight = Math.max(800, innerHeight);

    switch(stageNumber){
        case 1:
            platforms=[ {x:0,y:stageHeight-100,width:300,height:100,type:'ground'},
                        {x:300,y:stageHeight-100,width:300,height:100,type:'ground'},
                        {x:700,y:stageHeight-100,width:500,height:100,type:'ground'},
                        {x:400,y:stageHeight-250,width:120,height:30,type:'platform'},
                        {x:600,y:stageHeight-350,width:120,height:30,type:'platform'},
                        {x:800,y:stageHeight-450,width:120,height:30,type:'platform'} ];
            enemies=[ {x:400,y:stageHeight-150,width:40,height:40,velX:2,type:'goomba'},
                      {x:800,y:stageHeight-150,width:40,height:40,velX:-2,type:'goomba'} ];
            coins=[ {x:450,y:stageHeight-300,width:30,height:30,collected:false},
                    {x:650,y:stageHeight-400,width:30,height:30,collected:false},
                    {x:850,y:stageHeight-500,width:30,height:30,collected:false} ];
            break;

        case 2:
            platforms=[ {x:0,y:stageHeight-100,width:300,height:100,type:'ground'},
                        {x:400,y:stageHeight-100,width:200,height:100,type:'ground'},
                        {x:700,y:stageHeight-100,width:200,height:100,type:'ground'},
                        {x:1000,y:stageHeight-100,width:200,height:100,type:'ground'},
                        {x:1300,y:stageHeight-100,width:300,height:100,type:'ground'},
                        {x:1700,y:stageHeight-100,width:300,height:100,type:'ground'},
                        {x:300,y:stageHeight-300,width:100,height:30,type:'platform'},
                        {x:600,y:stageHeight-300,width:100,height:30,type:'platform'},
                        {x:900,y:stageHeight-300,width:100,height:30,type:'platform'},
                        {x:1200,y:stageHeight-400,width:100,height:30,type:'platform'} ];
            enemies=[ {x:500,y:stageHeight-150,width:40,height:40,velX:2,type:'goomba'},
                      {x:1100,y:stageHeight-150,width:40,height:40,velX:-2,type:'goomba'},
                      {x:1400,y:stageHeight-150,width:40,height:40,velX:2,type:'goomba'} ];
            coins=[ {x:350,y:stageHeight-350,width:30,height:30,collected:false},
                    {x:650,y:stageHeight-350,width:30,height:30,collected:false},
                    {x:950,y:stageHeight-350,width:30,height:30,collected:false},
                    {x:1250,y:stageHeight-450,width:30,height:30,collected:false},
                    {x:1500,y:stageHeight-200,width:30,height:30,collected:false} ];
            break;

        case 3:
            platforms=[ {x:0,y:stageHeight-100,width:300,height:100,type:'ground'},
                        {x:500,y:stageHeight-100,width:200,height:100,type:'ground'},
                        {x:900,y:stageHeight-100,width:200,height:100,type:'ground'},
                        {x:1300,y:stageHeight-100,width:200,height:100,type:'ground'},
                        {x:1700,y:stageHeight-100,width:200,height:100,type:'ground'},
                        {x:2100,y:stageHeight-100,width:400,height:100,type:'ground'} ];
            movingPlatforms=[ {x:350,y:stageHeight-300,width:120,height:30,velX:2,minX:300,maxX:450},
                              {x:750,y:stageHeight-400,width:120,height:30,velX:-2,minX:700,maxX:850},
                              {x:1150,y:stageHeight-350,width:120,height:30,velX:2,minX:1100,maxX:1250} ];
            enemies=[ {x:600,y:stageHeight-150,width:40,height:40,velX:2,type:'goomba'},
                      {x:1000,y:stageHeight-150,width:40,height:40,velX:-2,type:'goomba'},
                      {x:1400,y:stageHeight-150,width:40,height:40,velX:2,type:'goomba'},
                      {x:1800,y:stageHeight-150,width:40,height:40,velX:-2,type:'goomba'} ];
            coins=[ {x:400,y:stageHeight-400,width:30,height:30,collected:false},
                    {x:800,y:stageHeight-500,width:30,height:30,collected:false},
                    {x:1200,y:stageHeight-450,width:30,height:30,collected:false},
                    {x:1500,y:stageHeight-250,width:30,height:30,collected:false},
                    {x:1900,y:stageHeight-300,width:30,height:30,collected:false},
                    {x:2200,y:stageHeight-200,width:30,height:30,collected:false} ];
            break;

        case 4:
            platforms=[ {x:0,y:stageHeight-100,width:300,height:100,type:'ground'},
                        {x:400,y:stageHeight-100,width:400,height:100,type:'ground'},
                        {x:900,y:stageHeight-100,width:300,height:100,type:'ground'},
                        {x:1300,y:stageHeight-100,width:400,height:100,type:'ground'},
                        {x:1800,y:stageHeight-100,width:300,height:100,type:'ground'},
                        {x:2200,y:stageHeight-100,width:300,height:100,type:'ground'},
                        {x:2600,y:stageHeight-100,width:400,height:100,type:'ground'},
                        {x:450,y:stageHeight-250,width:100,height:30,type:'platform'},
                        {x:650,y:stageHeight-350,width:100,height:30,type:'platform'},
                        {x:1000,y:stageHeight-300,width:100,height:30,type:'platform'},
                        {x:1500,y:stageHeight-400,width:100,height:30,type:'platform'} ];
            spikes=[ {x:550,y:stageHeight-130,width:60,height:30},
                     {x:1400,y:stageHeight-130,width:60,height:30},
                     {x:1500,y:stageHeight-130,width:60,height:30},
                     {x:2300,y:stageHeight-130,width:60,height:30} ];
            enemies=[ {x:500,y:stageHeight-150,width:40,height:40,velX:2,type:'goomba'},
                      {x:1000,y:stageHeight-150,width:40,height:40,velX:-2,type:'goomba'},
                      {x:1600,y:stageHeight-150,width:40,height:40,velX:2,type:'goomba'},
                      {x:2000,y:stageHeight-150,width:40,height:40,velX:-2,type:'goomba'},
                      {x:2700,y:stageHeight-150,width:40,height:40,velX:2,type:'goomba'} ];
            coins=[ {x:500,y:stageHeight-300,width:30,height:30,collected:false},
                    {x:700,y:stageHeight-400,width:30,height:30,collected:false},
                    {x:1050,y:stageHeight-350,width:30,height:30,collected:false},
                    {x:1550,y:stageHeight-450,width:30,height:30,collected:false},
                    {x:1900,y:stageHeight-200,width:30,height:30,collected:false},
                    {x:2400,y:stageHeight-300,width:30,height:30,collected:false},
                    {x:2800,y:stageHeight-400,width:30,height:30,collected:false} ];
            break;

        case 5:
            platforms=[ {x:0,y:stageHeight-100,width:300,height:100,type:'ground'},
                        {x:450,y:stageHeight-100,width:250,height:100,type:'ground'},
                        {x:850,y:stageHeight-100,width:250,height:100,type:'ground'},
                        {x:1250,y:stageHeight-100,width:250,height:100,type:'ground'},
                        {x:1650,y:stageHeight-100,width:250,height:100,type:'ground'},
                        {x:2050,y:stageHeight-100,width:250,height:100,type:'ground'},
                        {x:2450,y:stageHeight-100,width:300,height:100,type:'ground'},
                        {x:2900,y:stageHeight-100,width:400,height:100,type:'ground'},
                        {x:350,y:stageHeight-300,width:80,height:30,type:'platform'},
                        {x:750,y:stageHeight-350,width:80,height:30,type:'platform'},
                        {x:1150,y:stageHeight-400,width:80,height:30,type:'platform'},
                        {x:1550,y:stageHeight-350,width:80,height:30,type:'platform'},
                        {x:1950,y:stageHeight-450,width:80,height:30,type:'platform'} ];
            movingPlatforms=[ {x:550,y:stageHeight-450,width:100,height:30,velX:3,minX:450,maxX:650},
                              {x:1350,y:stageHeight-500,width:100,height:30,velX:-3,minX:1250,maxX:1450} ];
            enemies=[ {x:500,y:stageHeight-150,width:40,height:40,velX:2,type:'goomba'},
                      {x:900,y:stageHeight-150,width:40,height:40,velX:-2,type:'goomba'},
                      {x:1300,y:stageHeight-150,width:40,height:40,velX:2,type:'goomba'},
                      {x:1700,y:stageHeight-150,width:40,height:40,velX:-2,type:'goomba'},
                      {x:2100,y:stageHeight-150,width:40,height:40,velX:2,type:'goomba'},
                      {x:700,y:stageHeight-500,width:50,height:50,velX:2,type:'flying',originalY:stageHeight-500},
                      {x:1500,y:stageHeight-550,width:50,height:50,velX:-2,type:'flying',originalY:stageHeight-550} ];
            spikes=[ {x:950,y:stageHeight-130,width:60,height:30},
                     {x:1750,y:stageHeight-130,width:60,height:30} ];
            coins=[ {x:380,y:stageHeight-350,width:30,height:30,collected:false},
                    {x:600,y:stageHeight-550,width:30,height:30,collected:false},
                    {x:780,y:stageHeight-400,width:30,height:30,collected:false},
                    {x:1180,y:stageHeight-450,width:30,height:30,collected:false},
                    {x:1400,y:stageHeight-600,width:30,height:30,collected:false},
                    {x:1580,y:stageHeight-400,width:30,height:30,collected:false},
                    {x:1980,y:stageHeight-500,width:30,height:30,collected:false},
                    {x:2500,y:stageHeight-200,width:30,height:30,collected:false} ];
            break;

        default:
            // 6以降：簡易手続き生成
            const seed = stageNumber * 12345;
            const random = (max)=>{ const x=Math.sin(seed)*10000; return Math.floor((x-Math.floor(x))*max); };

            for(let i=0;i<stageWidth;i+=300){
                if(i % (900 - stageNumber*30) !== 600){
                    platforms.push({x:i,y:stageHeight-100,width:300,height:100,type:'ground'});
                }
            }
            const platformCount = 10 + stageNumber;
            for(let i=0;i<platformCount;i++){
                const x = 200 + (i*(stageWidth-400)/platformCount);
                const y = stageHeight - 250 - (i%3)*150;
                platforms.push({x,y,width:100 - stageNumber*2,height:30,type:'platform'});
            }
            const movingCount = Math.floor(stageNumber/2);
            for(let i=0;i<movingCount;i++){
                const x=500 + i*600, y=stageHeight - 400 - (i%2)*100;
                movingPlatforms.push({x,y,width:100,height:30,velX:2+stageNumber*0.3,minX:x-100,maxX:x+100});
            }
            const enemyCount = 5 + stageNumber*2;
            for(let i=0;i<enemyCount;i++){
                const x = 300 + (i*(stageWidth-600)/enemyCount);
                enemies.push({x, y:stageHeight-150, width:40, height:40, velX: i%2===0 ? 2+stageNumber*0.2 : -(2+stageNumber*0.2), type:'goomba'});
            }
            const flyingCount = stageNumber - 4;
            for(let i=0;i<flyingCount;i++){
                enemies.push({ x:600 + i*500, y:stageHeight-500, width:50, height:50, velX: i%2===0?2:-2, type:'flying', originalY:stageHeight-500 });
            }
            const spikeCount = stageNumber - 2;
            for(let i=0;i<spikeCount;i++){
                spikes.push({ x:400 + i*400, y:stageHeight-130, width:60, height:30 });
            }
            const coinCount = 10 + stageNumber;
            for(let i=0;i<coinCount;i++){
                const x = 200 + (i*(stageWidth-400)/coinCount);
                const y = stageHeight - 300 - (i%4)*100;
                coins.push({x,y,width:30,height:30,collected:false});
            }
            break;
    }

    // ゴール（初期値）
    goal = { x:stageWidth - 150, y:stageHeight - 250, width:60, height:150 };

    // プレイヤー初期化
    player.x=100; player.y=stageHeight-300; player.velX=0; player.velY=0; cameraX=0; cameraY=0;

    // まず“落とし穴短縮”→ その後“ゴール滑走路保証”
    patchUnjumpableGaps();
    ensureGoalRunway();
}

// リスタート等
function restartGame(){ score=0; lives=3; gameOver=false; levelComplete=false; currentStage=1; generateStage(currentStage); }
function retryCurrentStage(){ lives=3; gameOver=false; levelComplete=false; generateStage(currentStage); }

// 入力
addEventListener('keydown', e=>{
    if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','a','d','w','s',' '].includes(e.key)) e.preventDefault();
    keys[e.key]=true;
    if(e.key==='p'||e.key==='P'){ gameOver ? retryCurrentStage() : restartGame(); }
});
addEventListener('keyup', e=>{
    if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','a','d','w','s',' '].includes(e.key)) e.preventDefault();
    keys[e.key]=false;
});

// 衝突
function checkCollision(a,b){ return a.x<b.x+b.width && a.x+a.width>b.x && a.y<b.y+b.height && a.y+a.height>b.y; }

// カメラ
function updateCamera(){
    const tx = player.x - canvas.width/2, ty = player.y - canvas.height/2;
    cameraX = Math.max(0, Math.min(tx, stageWidth - canvas.width));
    cameraY = Math.max(0, Math.min(ty, stageHeight - canvas.height));
}

// プレイヤー
function updatePlayer(){
    if(keys['ArrowLeft']||keys['a']) player.velX = -player.speed;
    else if(keys['ArrowRight']||keys['d']) player.velX = player.speed;
    else player.velX *= friction;

    if((keys['ArrowUp']||keys['w']||keys[' ']) && player.grounded){ player.velY = player.jumpPower; player.grounded=false; }

    player.velY += gravity;
    player.x += player.velX; player.y += player.velY;

    if(player.x<0) player.x=0;
    if(player.x+player.width>stageWidth) player.x=stageWidth-player.width;
    if(player.y>stageHeight) respawnPlayer();

    player.grounded=false;
    const allPlatforms=[...platforms, ...movingPlatforms];
    for(const p of allPlatforms){
        if(checkCollision(player,p)){
            if(player.velY>0 && player.y<p.y){ // 上から
                player.y = p.y - player.height; player.velY=0; player.grounded=true; if(p.velX) player.x += p.velX;
            }else if(player.velY<0 && player.y>p.y){ // 下から
                player.y = p.y + p.height; player.velY=0;
            }else if(player.velX>0 && player.x<p.x){ // 右から
                player.x = p.x - player.width; player.velX=0;
            }else if(player.velX<0 && player.x>p.x){ // 左から
                player.x = p.x + p.width; player.velX=0;
            }
        }
    }

    for(const s of spikes){ if(checkCollision(player,s)) respawnPlayer(); }

    if(checkCollision(player,goal)) levelComplete=true;
}

// 動く足場
function updateMovingPlatforms(){
    for(const p of movingPlatforms){
        p.x += p.velX;
        if(p.x<=p.minX || p.x>=p.maxX) p.velX *= -1;
    }
}

// 敵
function updateEnemies(){
    for(let i=enemies.length-1;i>=0;i--){
        const e=enemies[i]; e.x += e.velX;
        if(e.type==='flying'){ e.y = e.originalY + Math.sin(Date.now()*0.003)*30; }
        if(e.x<=0 || e.x+e.width>=stageWidth) e.velX *= -1;

        if(checkCollision(player,e)){
            if(player.velY>0 && player.y<e.y){ enemies.splice(i,1); score+=100; player.velY = player.jumpPower/2; }
            else respawnPlayer();
        }
    }
}

// コイン
function updateCoins(){ for(const c of coins){ if(!c.collected && checkCollision(player,c)){ c.collected=true; score+=50; } } }

// リスポーン
function respawnPlayer(){
    lives--;
    if(lives<=0) gameOver=true;
    else{ player.x=100; player.y=stageHeight-300; player.velX=0; player.velY=0; cameraX=0; cameraY=0; }
}

// 次ステージ
function nextStage(){
    currentStage++;
    if(currentStage>10) gameOver=true;
    else{ levelComplete=false; generateStage(currentStage); score+=1000; }
}

// 描画
function draw(){
    ctx.fillStyle='#5C94FC'; ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.save(); ctx.translate(-cameraX,-cameraY);

    // 雲
    ctx.fillStyle='#FFFFFF';
    for(let i=0;i<stageWidth;i+=600){
        const px = i - cameraX*0.3;
        ctx.fillRect(px+150,100,120,45);
        ctx.fillRect(px+180,85,60,30);
        ctx.fillRect(px+450,150,150,50);
        ctx.fillRect(px+480,135,90,35);
    }

    // 地面・足場
    for(const p of platforms){
        if(p.type==='ground'){
            ctx.fillStyle='#8B4513'; ctx.fillRect(p.x,p.y,p.width,p.height);
            ctx.fillStyle='#228B22'; ctx.fillRect(p.x,p.y,p.width,10);
        }else{
            ctx.fillStyle='#8B4513'; ctx.fillRect(p.x,p.y,p.width,p.height);
        }
    }

    // 動く足場
    ctx.fillStyle='#696969';
    for(const p of movingPlatforms){ ctx.fillRect(p.x,p.y,p.width,p.height); }

    // スパイク
    ctx.fillStyle='#FF0000';
    for(const s of spikes){
        for(let i=0;i<s.width;i+=10){
            ctx.beginPath();
            ctx.moveTo(s.x+i, s.y+s.height);
            ctx.lineTo(s.x+i+5, s.y);
            ctx.lineTo(s.x+i+10, s.y+s.height);
            ctx.fill();
        }
    }

    // コイン
    for(const c of coins){
        if(!c.collected){
            ctx.fillStyle='#FFD700';
            ctx.beginPath();
            ctx.arc(c.x+c.width/2, c.y+c.height/2, c.width/2, 0, Math.PI*2);
            ctx.fill();
        }
    }

    // 敵
    for(const e of enemies){
        if(e.type==='flying'){
            ctx.fillStyle='#800080'; ctx.fillRect(e.x,e.y,e.width,e.height);
            ctx.fillStyle='#9932CC'; ctx.fillRect(e.x-10,e.y+5,10,15); ctx.fillRect(e.x+e.width,e.y+5,10,15);
        }else{
            ctx.fillStyle='#8B4513'; ctx.fillRect(e.x,e.y,e.width,e.height);
        }
        ctx.fillStyle='#000'; ctx.fillRect(e.x+5,e.y+5,5,5); ctx.fillRect(e.x+e.width-10,e.y+5,5,5);
    }

    // ゴール
    ctx.fillStyle='#0F0'; ctx.fillRect(goal.x,goal.y,goal.width,goal.height);
    ctx.fillStyle='#FFF'; ctx.fillRect(goal.x+15,goal.y+10,10,10);
    ctx.fillStyle='#F00'; ctx.beginPath(); ctx.moveTo(goal.x+20,goal.y+30); ctx.lineTo(goal.x+40,goal.y+40); ctx.lineTo(goal.x+20,goal.y+50); ctx.fill();

    // プレイヤー
    ctx.fillStyle=player.color; ctx.fillRect(player.x,player.y,player.width,player.height);
    ctx.fillStyle='#F00'; ctx.fillRect(player.x-2,player.y-5,player.width+4,8);
    ctx.fillStyle='#FFB6C1'; ctx.fillRect(player.x+5,player.y+10,20,15);
    ctx.fillStyle='#000'; ctx.fillRect(player.x+8,player.y+15,3,3); ctx.fillRect(player.x+19,player.y+15,3,3);

    ctx.restore();

    // UI
    document.getElementById('stage').textContent=currentStage;
    document.getElementById('score').textContent=score;
    document.getElementById('lives').textContent=lives;

    // オーバーレイ
    if(gameOver){
        ctx.fillStyle='rgba(0,0,0,.7)'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle='#FFF'; ctx.font='48px Arial'; ctx.textAlign='center';
        if(currentStage>10){ ctx.fillText('全ステージクリア！', canvas.width/2, canvas.height/2-50); ctx.font='36px Arial'; ctx.fillText(`最終スコア: ${score}`, canvas.width/2, canvas.height/2+20); }
        else ctx.fillText('GAME OVER', canvas.width/2, canvas.height/2);
        ctx.font='24px Arial'; ctx.fillText('Pキーでリスタート', canvas.width/2, canvas.height/2+70);
    }
    if(levelComplete && !gameOver){
        ctx.fillStyle='rgba(0,0,0,.7)'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle='#FFF'; ctx.font='48px Arial'; ctx.textAlign='center';
        ctx.fillText(`ステージ ${currentStage} クリア!`, canvas.width/2, canvas.height/2);
        ctx.font='24px Arial'; ctx.fillText('スペースキーで次のステージへ', canvas.width/2, canvas.height/2+50);
    }
}

// ループ
function gameLoop(){
    if(!gameOver && !levelComplete){
        updatePlayer(); updateEnemies(); updateCoins(); updateMovingPlatforms(); updateCamera();
    }else if(levelComplete && keys[' ']){ nextStage(); }
    draw(); requestAnimationFrame(gameLoop);
}

// 初期化
generateStage(currentStage);
gameLoop();
</script>
</body>
</html>
